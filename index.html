<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHANG SMART SCANNER</title>
    <style>
        :root { --neon: #00f2ff; --bg: #0a0a0c; --card: #16161a; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; padding: 15px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .scan-btn { padding: 10px 20px; border-radius: 20px; border: 2px solid var(--neon); background: transparent; color: var(--neon); font-weight: bold; cursor: pointer; }
        .scan-btn:active { background: var(--neon); color: #000; }

        /* LOADING ANIMATION */
        #loading { display: none; text-align: center; margin: 20px 0; color: var(--neon); font-size: 14px; }
        .spinner { width: 20px; height: 20px; border: 3px solid #333; border-top: 3px solid var(--neon); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* DANH S√ÅCH */
        .device-card { background: var(--card); padding: 15px; border-radius: 20px; border: 1px solid #222; margin-bottom: 12px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        .info { margin-bottom: 15px; }
        .info b { color: var(--neon); display: block; margin-bottom: 4px; }
        .info span { font-size: 12px; color: #666; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button.ctrl { padding: 12px; border-radius: 10px; border: none; background: #2d2d35; color: white; font-size: 12px; font-weight: bold; cursor: pointer; }
        button.pwr { grid-column: span 2; background: #ff4757; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="font-size: 18px;">H·ªÜ TH·ªêNG C·ª¶A KHANG</h1>
    <button class="scan-btn" onclick="startScan()">üîç D√í THI·∫æT B·ªä</button>
</div>

<div id="loading">
    <div class="spinner"></div> ƒêang qu√©t m·∫°ng n·ªôi b·ªô...
</div>

<div id="device-container">
    <p style="text-align:center; color:#444; margin-top: 50px;">Nh·∫•n "D√≤ thi·∫øt b·ªã" ƒë·ªÉ b·∫Øt ƒë·∫ßu k·∫øt n·ªëi.</p>
</div>

<script>
    // H√†m d√≤ t√¨m thi·∫øt b·ªã
    async function startScan() {
        const container = document.getElementById('device-container');
        const loading = document.getElementById('loading');
        
        container.innerHTML = "";
        loading.style.display = "block";

        // Gi·∫£ s·ª≠ m·∫°ng nh√† b·∫°n l√† 192.168.1.x
        // Ch√∫ng ta s·∫Ω qu√©t c√°c IP t·ª´ 192.168.1.1 ƒë·∫øn 192.168.1.50 (qu√©t √≠t ƒë·ªÉ nhanh)
        const baseIP = "192.168.1."; 
        const foundDevices = [];

        for (let i = 1; i <= 50; i++) {
            const ip = baseIP + i;
            
            // D√πng k·ªπ thu·∫≠t ping ng·∫ßm b·∫±ng Image
            const check = new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve({ip, status: 'online'});
                img.onerror = () => resolve(null);
                // Thi·∫øt b·ªã c·ªßa b·∫°n (ESP32) c·∫ßn c√≥ 1 file ·∫£nh nh·ªè ho·∫∑c link /status ƒë·ªÉ nh·∫≠n di·ªán
                img.src = `http://${ip}/ping?t=${Date.now()}`;
                
                // Sau 500ms kh√¥ng th·∫•y ph·∫£n h·ªìi th√¨ b·ªè qua
                setTimeout(() => resolve(null), 500);
            });

            const result = await check;
            if (result) {
                renderDevice(result.ip);
            }
        }

        loading.style.display = "none";
        if(container.innerHTML === "") {
            container.innerHTML = '<p style="text-align:center; color:#ff4757">Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã n√†o ƒëang m·ªü!</p>';
        }
    }

    function renderDevice(ip) {
        const container = document.getElementById('device-container');
        const card = document.createElement('div');
        card.className = 'device-card';
        card.innerHTML = `
            <div class="info">
                <b>THI·∫æT B·ªä T√åM TH·∫§Y</b>
                <span>ƒê·ªãa ch·ªâ IP: ${ip}</span>
            </div>
            <div class="btn-group">
                <button class="ctrl pwr" onclick="send('${ip}', 'POWER')">B·∫¨T / T·∫ÆT</button>
                <button class="ctrl" onclick="send('${ip}', 'UP')">L√äN / TƒÇNG</button>
                <button class="ctrl" onclick="send('${ip}', 'DOWN')">XU·ªêNG / GI·∫¢M</button>
            </div>
        `;
        container.appendChild(card);
    }

    function send(ip, cmd) {
        const img = new Image();
        img.src = `http://${ip}/control?cmd=${cmd}&t=${Date.now()}`;
        alert("ƒê√£ g·ª≠i l·ªánh " + cmd + " t·ªõi " + ip);
    }
</script>
</body>
</html>
